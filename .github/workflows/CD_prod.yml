name: ðŸš€ CD - Production Environment

on:
  push:
    branches:
      - main

jobs:
  deploy-prod:
    name: ðŸ³ Build, Deploy & Notify
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # âœ… AÃ±adido id: build para rastrear este paso
      - name: Build and Push Docker Image (Prod)
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/images/Dockerfile.prod
          push: true
          tags: |
            ${{ secrets.DOCKER_USER }}/formula-hub:latest
            ${{ secrets.DOCKER_USER }}/formula-hub:${{ github.sha }}

      # âœ… El id: render ya estaba, lo usamos para rastrear este paso
      - name: Trigger Render Prod Deployment
        id: render
        # Solo intentamos llamar a Render si el Build fue bien
        if: steps.build.outcome == 'success'
        run: |
          if curl -f "${{ secrets.RENDER_PRODUCTION_DEPLOY_HOOK_URL }}"; then
             echo "status=success" >> $GITHUB_OUTPUT
          else
             echo "status=failure" >> $GITHUB_OUTPUT
             exit 1
          fi

      # ðŸ”” NotificaciÃ³n Inteligente
      - name: Notify Discord
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          BUILD_STATUS: ${{ steps.build.outcome }}
          DEPLOY_STATUS: ${{ steps.render.outcome }}
        run: |
          # LÃ³gica de mensajes REAL
          if [[ "$BUILD_STATUS" != "success" ]]; then
            COLOR=15548997 # Rojo
            TITLE="ðŸ”¥ Fallo en Docker Hub"
            DESC="No se pudo construir la imagen. No se ha intentado desplegar."

          elif [[ "$DEPLOY_STATUS" != "success" ]]; then
            COLOR=15105570 # Naranja
            TITLE="ðŸ’¥ Fallo en Render"
            DESC="La imagen subiÃ³ bien, pero **Render no ha podido arrancarla**. La web puede estar caÃ­da o usando la versiÃ³n anterior.\nRevisa los logs de Render."

          else
            COLOR=5763719 # Verde
            TITLE="âœ… Despliegue COMPLETADO"
            DESC="Render ha confirmado que la nueva versiÃ³n estÃ¡ **Online**."
          fi

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"embeds\": [{\"title\": \"$TITLE\", \"description\": \"$DESC\", \"color\": $COLOR}]}" \
               $DISCORD_WEBHOOK
